<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A specialty farmer. Program execution. Playbook. - Preview</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="error-handler.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Georgia", "Times New Roman", serif;
        background: radial-gradient(circle at 15% 20%, #f1f7ff 0%, #e8eef7 28%, transparent 45%), radial-gradient(circle at 80% 10%, #fef6e8 0%, #f8eedd 25%, transparent 45%), #e3e8f1;
        padding: 20px;
        line-height: 1.7;
        color: #333;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      @page {
        size: letter;
        margin: 0.5in;
      }

      .pdf-export-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 2000;
        width: 44px;
        height: 44px;
        background: #f4f6f8;
        color: #34495e;
        border: none;
        padding: 0;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
        transition: background 0.2s ease, transform 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .pdf-export-btn:hover {
        background: #e7ebf0;
        transform: translateY(-1px);
      }

      .pdf-export-btn:active {
        transform: scale(0.96);
      }

      .pdf-export-btn.exporting {
        background: #dfe3e7;
        cursor: wait;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: transparent;
        box-shadow: none;
      }

      .page {
        width: 8.5in;
        min-height: 11in;
        max-height: 11in;
        padding: 1in;
        margin: 0 auto 20px;
        background: linear-gradient(160deg, #ffffff 0%, #fdfefe 60%, #f5f8fc 100%);
        position: relative;
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.14);
        overflow: hidden;
        page-break-inside: auto;
        break-inside: auto;
        page-break-after: always;
        break-after: page;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }
      
      /* Page content wrapper that flows to next page when full */
      .page-content {
        flex: 1;
        overflow: visible;
      }

      /* Cover page - exactly letter size */
      .page#cover {
        height: 11in;
        min-height: 11in;
        max-height: 11in;
        overflow: hidden;
        page-break-after: always;
        break-after: page;
      }

      /* TOC page - exactly letter size, allow scrolling if content exceeds */
      .page#toc {
        height: 11in;
        min-height: 11in;
        max-height: 11in;
        overflow-y: auto;
        overflow-x: hidden;
        page-break-after: always;
        break-after: page;
      }

      /* Content pages - exactly letter size (11in height) */
      .page:not(#cover):not(#toc) {
        width: 8.5in;
        height: 11in;
        min-height: 11in;
        max-height: 11in;
        padding: 1in;
        margin: 0 auto 20px;
        background: white;
        position: relative;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        page-break-after: always;
        break-after: page;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }
      
      /* Ensure page content respects page boundaries */
      .page:not(#cover):not(#toc) .page-content {
        max-height: 9.5in; /* 11in page - 1in top padding - 0.5in bottom space - 0.1in buffer = ~9.5in */
        overflow: hidden;
      }
      
      /* Page content wrapper - content area fits within page */
      .page-content {
        flex: 1;
        min-height: 0;
        overflow: hidden;
        padding-bottom: 0.5in; /* Space for page number at bottom */
        /* Professional typography - prevent orphaned lines */
        orphans: 2;
        widows: 2;
        background: linear-gradient(135deg, rgba(244, 247, 252, 0.9) 0%, rgba(255, 255, 255, 0.95) 70%);
        border-radius: 10pt;
        padding: 18pt 18pt 32pt 18pt;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.6), inset 0 -1px 0 rgba(0,0,0,0.03);
      }

      /* Subtle section dividers */
      .page-content > * + * {
        margin-top: 10pt;
      }

      /* Last page - can be shorter if content doesn't fill it */
      .page:last-of-type {
        min-height: auto;
        height: auto;
        max-height: 11in;
        overflow: visible;
      }
      
      .page:last-of-type .page-content {
        max-height: none;
        overflow: visible;
      }
      
      /* Sections (h2) always start on a new page */
      .page:not(#cover):not(#toc) > .page-content > h2:first-child {
        page-break-before: always;
        break-before: page;
        margin-top: 0;
      }

      @media print {
        body {
          background: white;
          padding: 0;
        }
        .page {
          margin: 0;
          box-shadow: none;
          width: 8.5in;
          min-height: 11in;
          height: auto;
          max-height: none;
          overflow: visible;
          page-break-after: always;
          break-after: page;
        }
        .page#cover {
          page-break-after: always;
          break-after: page;
          height: 11in;
        }
        .page#toc {
          page-break-after: always;
          break-after: page;
          height: auto;
          min-height: 11in;
        }
        .page:not(#cover):not(#toc) {
          page-break-after: auto;
          break-after: auto;
          height: auto;
          min-height: 11in;
          max-height: none;
        }
        .page:last-of-type {
          page-break-after: auto;
          break-after: auto;
          min-height: auto;
        }
        h2 {
          page-break-before: always;
          break-before: page;
          page-break-after: avoid;
          break-after: avoid;
        }
        .page > h2:first-child {
          page-break-before: auto;
          break-before: auto;
        }
        .toc-item {
          page-break-inside: avoid;
          break-inside: avoid;
        }
        /* Prevent orphaned lines - professional PDF standards */
        p, li {
          orphans: 2; /* Allow lists to stay on current page when space remains */
          widows: 2;
        }
        /* Allow paragraph breaking but keep related content together */
        p {
          page-break-inside: auto;
          break-inside: auto;
        }
        /* Allow list items to flow when needed (prevents whole list jumping pages) */
        li {
          page-break-inside: auto;
          break-inside: auto;
        }
        /* Keep headings with following content */
        h2, h3 {
          page-break-after: avoid;
          break-after: avoid;
        }
        .pdf-export-btn,
        .floating-toc,
        .search-toolbar,
        .search-shell,
        .search-toggle {
          display: none;
        }
      }

      .page-number {
        position: absolute;
        bottom: 0.5in;
        right: 1in;
        font-size: 10pt;
        color: #666;
      }

      h1 {
        font-size: 28pt;
        text-align: center;
        margin: 28pt 0 18pt 0;
        color: #1a252f;
        font-weight: 700;
        letter-spacing: 0.8px;
        text-transform: uppercase;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
        page-break-after: avoid;
      }

      h1::after {
        content: '';
        position: absolute;
        bottom: -6pt;
        left: 50%;
        transform: translateX(-50%);
        width: 90pt;
        height: 3px;
        background: linear-gradient(90deg, transparent, #3498db, transparent);
      }

      h2 {
        font-size: 20pt;
        margin-top: 0;
        margin-bottom: 16pt;
        padding-top: 18pt;
        color: #2c3e50;
        font-weight: 700;
        letter-spacing: 0.4px;
        border-bottom: 3px solid #3498db;
        padding-bottom: 8pt;
        position: relative;
        page-break-before: always;
        page-break-after: avoid;
        break-before: page;
        break-after: avoid;
        orphans: 2;
        widows: 2;
      }

      h2::before {
        content: '';
        position: absolute;
        left: 0;
        bottom: -3px;
        width: 60pt;
        height: 3px;
        background: #e74c3c;
      }

      /* Section headers with icons */
      .section-header-with-icon {
        display: flex;
        align-items: center;
        gap: 10pt;
        font-size: 20pt;
        margin-top: 0;
        margin-bottom: 16pt;
        padding: 18pt 14pt 10pt 14pt;
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        background: linear-gradient(135deg, #f7fafc 0%, #ffffff 40%, #f0f4f8 100%);
        border-left: 6pt solid #3498db;
        border-radius: 6pt;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        page-break-before: always;
        page-break-after: avoid;
        break-before: page;
        break-after: avoid;
        orphans: 2;
        widows: 2;
      }

      .section-header-with-icon i {
        font-size: 22pt;
        margin-right: 2pt;
        vertical-align: middle;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
      }

      .section-header-with-icon span {
        flex: 1;
        font-weight: 700;
        letter-spacing: 0.4px;
      }

      /* First h2 in a page doesn't need page break */
      .page > h2:first-child,
      .page > .section-header-with-icon:first-child {
        page-break-before: auto;
        break-before: auto;
        padding-top: 0;
      }

      h3 {
        font-size: 16pt;
        margin-top: 20pt;
        margin-bottom: 12pt;
        color: #34495e;
        font-weight: 600;
        letter-spacing: 0.3px;
        padding: 10pt 14pt;
        background: linear-gradient(to right, rgba(52, 152, 219, 0.08) 0%, transparent 100%);
        border-left: 5pt solid #3498db;
        border-radius: 4pt;
        page-break-before: avoid;
        page-break-after: avoid;
        break-before: avoid;
        break-after: avoid;
        orphans: 2;
        widows: 2;
        position: relative;
        padding-left: 18pt;
      }

      h3::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 5pt;
        background: linear-gradient(180deg, #3498db 0%, #2980b9 100%);
        border-radius: 4pt 0 0 4pt;
      }

      /* Subsection headers with icons */
      .subsection-header-with-icon {
        display: flex;
        align-items: center;
        gap: 8pt;
        font-size: 16pt;
        margin-top: 20pt;
        margin-bottom: 12pt;
        color: #34495e;
        font-weight: 600;
        letter-spacing: 0.3px;
        padding: 10pt 14pt;
        background: linear-gradient(to right, rgba(52, 152, 219, 0.08) 0%, transparent 100%);
        border-left: 5pt solid #3498db;
        border-radius: 4pt;
        page-break-before: avoid;
        page-break-after: avoid;
        break-before: avoid;
        break-after: avoid;
        orphans: 2;
        widows: 2;
      }

      .subsection-header-with-icon i {
        font-size: 16pt;
        vertical-align: middle;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        flex-shrink: 0;
      }

      .subsection-header-with-icon span {
        flex: 1;
      }

      h4 {
        font-size: 12pt;
        margin-top: 12pt;
        margin-bottom: 8pt;
        color: #2c3e50;
        font-weight: 600;
        page-break-before: avoid;
        page-break-after: avoid;
        break-before: avoid;
        break-after: avoid;
        orphans: 2;
        widows: 2;
      }

      /* Enhanced h4 headers with icons */
      .h4-with-icon {
        display: flex;
        align-items: center;
        gap: 10pt;
        font-size: 12.5pt;
        margin-top: 14pt;
        margin-bottom: 10pt;
        padding: 10pt 14pt;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 50%, #f0f4f8 100%);
        border-left: 5pt solid #3498db;
        border-radius: 6pt;
        color: #2c3e50;
        font-weight: 700;
        letter-spacing: 0.4px;
        text-transform: uppercase;
        page-break-before: avoid;
        page-break-after: avoid;
        break-before: avoid;
        break-after: avoid;
        orphans: 2;
        widows: 2;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
        position: relative;
        overflow: hidden;
      }

      .h4-with-icon::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 5pt;
        height: 100%;
        background: linear-gradient(180deg, #3498db 0%, #2980b9 50%, #e74c3c 100%);
        border-radius: 6pt 0 0 6pt;
      }

      .h4-with-icon .h4-icon {
        flex-shrink: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 30pt;
        height: 30pt;
        background: linear-gradient(135deg, rgba(52, 152, 219, 0.15) 0%, rgba(52, 152, 219, 0.05) 100%);
        border-radius: 6pt;
        padding: 6pt;
        border: 2px solid rgba(52, 152, 219, 0.2);
        position: relative;
        z-index: 1;
      }

      .h4-with-icon .h4-icon i {
        font-size: 16pt;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
      }

      .h4-with-icon span:last-child {
        flex: 1;
        position: relative;
        z-index: 1;
      }

      .cover-page {
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 9in;
      }

      .logo-container {
        margin-bottom: 30pt;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .logo {
        max-width: 200px;
        max-height: 200px;
        width: auto;
        height: auto;
      }

      .cover-title {
        font-size: 34pt;
        font-weight: 700;
        margin-bottom: 25pt;
        color: #1a252f;
        letter-spacing: 1pt;
        line-height: 1.5;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        font-style: normal;
        text-transform: none;
      }
      
      .cover-title br {
        display: block;
        margin: 10pt 0;
        content: "";
      }
      
      .cover-title br:first-child {
        margin-top: 0;
      }
      
      .cover-title br:last-child {
        margin-bottom: 0;
      }

      .cover-subtitle {
        font-size: 18pt;
        margin-bottom: 30pt;
        color: #7f8c8d;
      }

      .cover-info {
        font-size: 12pt;
        margin-top: 40pt;
        color: #7f8c8d;
      }

      .toc {
        margin-top: 15pt;
        font-size: 10pt;
        page-break-inside: auto;
      }

      .toc-item {
        margin: 5pt 0;
        font-size: 10pt;
        line-height: 1.4;
        page-break-inside: avoid;
        break-inside: avoid;
      }

      .toc-item a {
        color: #3498db;
        text-decoration: none;
        display: flex;
        justify-content: space-between;
      }

      .toc-item a:hover {
        text-decoration: underline;
      }

      .toc-item a span {
        color: #7f8c8d;
        font-weight: normal;
      }

      .toc-subitem {
        margin-left: 15pt;
        margin-top: 2pt;
        font-size: 9pt;
        line-height: 1.3;
        page-break-inside: avoid;
        break-inside: avoid;
      }

      .toc-subitem a {
        color: #7f8c8d;
      }

      p {
        margin: 10pt 0;
        text-align: justify;
        font-size: 11pt;
        orphans: 2;
        widows: 2;
      }

      ul, ol {
        margin: 12pt 0;
        padding: 12pt 18pt 12pt 26pt;
        background: linear-gradient(120deg, rgba(52, 152, 219, 0.05) 0%, rgba(46, 204, 113, 0.04) 40%, rgba(255, 255, 255, 0.96) 100%);
        border-left: 4pt solid #3498db;
        border-radius: 9pt;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        orphans: 2;
        widows: 2;
      }

      li {
        margin: 6pt 0;
        font-size: 11pt;
        page-break-inside: auto;
        break-inside: auto;
        position: relative;
        padding-left: 4pt;
      }

      ul li::marker,
      ol li::marker {
        color: #3498db;
        font-weight: 700;
      }

      .section-divider {
        border-top: 1px solid #ecf0f1;
        margin: 20pt 0;
      }

      .key-points {
        background: #f8f9fa;
        padding: 15pt;
        margin: 15pt 0;
        border-left: 4px solid #3498db;
      }

      .key-points h4 {
        margin-top: 0;
      }

      code {
        background: #f4f4f4;
        padding: 2pt 6pt;
        border-radius: 3pt;
        font-family: "Courier New", monospace;
        font-size: 10pt;
      }

      /* Image support */
      img {
        max-width: 100%;
        height: auto;
        page-break-inside: avoid;
        margin: 10pt 0;
      }

      .image-container {
        text-align: center;
        margin: 12pt 0;
        page-break-inside: avoid;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        background: #f7f9fc;
        border: 1px solid #e1e8f2;
        border-radius: 12px;
        padding: 3pt;
      }

      .image-caption {
        font-size: 9pt;
        color: #7f8c8d;
        margin-top: 5pt;
        font-style: italic;
      }

      .geo-scope-wrap {
        display: flex;
        align-items: flex-start;
        gap: 14pt;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        justify-content: center;
        margin-left: auto;
        margin-right: auto;
      }

      .geo-scope-wrap ul {
        flex: 1 1 280px;
        margin-top: 0;
      }

      .pipeline-diagram {
        width: 100%;
        max-width: 100%;
        max-height: 6.25in;
        height: auto;
        margin: 14pt 0 6pt;
        page-break-inside: avoid;
        break-inside: avoid;
        display: block;
        background: linear-gradient(135deg, #fdfefe, #f2f6fb);
        padding: 12pt;
        border-radius: 14px;
        border: 1px solid #dbe5f3;
        box-sizing: border-box;
        box-shadow: 0 10px 30px rgba(36, 64, 97, 0.12);
      }

      .pipeline-bg {
        fill: white;
        stroke: #dbe7f3;
        stroke-width: 2;
      }
      
      .pipeline-band {
        fill: rgba(52, 152, 219, 0.08);
        stroke: #e2ebf6;
        stroke-width: 2;
      }

      .pipeline-track {
        stroke: #c7d7e6;
        stroke-width: 10;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .pipeline-track-highlight {
        stroke: url(#pipelineGradient);
        stroke-width: 16;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .pipeline-arrowhead {
        fill: #617389;
        opacity: 0.75;
      }

      .pipeline-connector {
        stroke: #c2d4e8;
        stroke-width: 4;
      }

      .pipeline-card {
        fill: white;
        stroke: #d0deef;
        stroke-width: 2;
        filter: drop-shadow(0 6px 14px rgba(36, 64, 97, 0.18));
      }

      .pipeline-card-title {
        font-family: "Georgia", "Times New Roman", serif;
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.2px;
        fill: #1f2d3d;
        text-anchor: middle;
      }

      .pipeline-card-subtitle {
        font-family: "Georgia", "Times New Roman", serif;
        font-size: 16px;
        fill: #3b708d;
        letter-spacing: 0.1px;
        text-anchor: middle;
      }

      .pipeline-node {
        stroke: #ffffff;
        stroke-width: 5;
        filter: drop-shadow(0 3px 8px rgba(0, 0, 0, 0.16));
      }

      .pipeline-number {
        font-family: "Georgia", "Times New Roman", serif;
        font-size: 22px;
        font-weight: bold;
        fill: white;
        text-anchor: middle;
        dominant-baseline: middle;
      }

      .pipeline-note {
        font-family: "Georgia", "Times New Roman", serif;
        font-size: 13px;
        fill: #526981;
        font-weight: 600;
        letter-spacing: 0.2px;
      }

      .stage-1 {
        fill: #2e86de;
      }

      .stage-1-card {
        fill: #eaf3ff;
        stroke: #b9d4f5;
      }

      .stage-2 {
        fill: #17a589;
      }

      .stage-2-card {
        fill: #e8fbf4;
        stroke: #b9ead8;
      }

      .stage-3 {
        fill: #f39c12;
      }

      .stage-3-card {
        fill: #fff5e6;
        stroke: #f2cf9b;
      }

      .stage-4 {
        fill: #5c6bc0;
      }

      .stage-4-card {
        fill: #eef1ff;
        stroke: #c3cbe9;
      }

      .stage-5 {
        fill: #27ae60;
      }

      .stage-5-card {
        fill: #e9f6ec;
        stroke: #b7e3c5;
      }

      .stage-6 {
        fill: #d35400;
      }

      .stage-6-card {
        fill: #fff0e6;
        stroke: #f5c7a8;
      }

      .stage-7 {
        fill: #34495e;
      }

      .stage-7-card {
        fill: #eef1f5;
        stroke: #c7d0dc;
      }

      .search-shell {
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 520px;
        width: min(520px, calc(100vw - 140px));
        z-index: 1300;
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-end;
      }

      .search-toggle {
        border: 1px solid #dce6f2;
        background: #ffffff;
        color: #1f2d3d;
        border-radius: 999px;
        padding: 10px 14px;
        font-size: 11pt;
        font-weight: 700;
        letter-spacing: 0.2px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border 0.2s ease;
        pointer-events: auto;
      }

      .search-toggle:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 28px rgba(0, 0, 0, 0.14);
        background: #f7faff;
        border-color: #c5d7f2;
      }

      .search-shell:not(.collapsed) .search-toggle {
        background: #eaf1ff;
        border-color: #c8d8f5;
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.14);
      }

      .search-toolbar {
        width: 100%;
        background: white;
        padding: 12px 14px;
        border: 1px solid #dce6f2;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.14);
        display: grid;
        gap: 8px;
        align-items: center;
      }

      .search-toolbar label {
        font-size: 10pt;
        color: #526981;
        font-weight: 600;
        letter-spacing: 0.3px;
      }

      .search-input-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        align-items: center;
      }

      .search-field {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d6deea;
        border-radius: 10px;
        font-size: 12pt;
        font-family: inherit;
        background: #f9fbff;
        transition: all 0.2s ease;
      }

      .search-field:focus {
        outline: none;
        border-color: #3498db;
        background: #ffffff;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
      }

      .search-clear {
        padding: 10px 12px;
        border: 1px solid #d6deea;
        background: #f5f7fb;
        color: #526981;
        border-radius: 10px;
        cursor: pointer;
        font-size: 11pt;
        transition: background 0.2s ease, color 0.2s ease, transform 0.1s ease;
      }

      .search-clear:hover {
        background: #eaf1fb;
        color: #34495e;
      }

      .search-clear:active {
        transform: translateY(1px);
      }

      .search-status {
        font-size: 9.5pt;
        color: #7f8c8d;
      }

      .search-results {
        max-height: 260px;
        overflow-y: auto;
        border-top: 1px solid #edf2f7;
        padding-top: 6px;
        display: none;
      }

      .search-results.active {
        display: block;
      }

      .search-result {
        width: 100%;
        text-align: left;
        background: #f9fbff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 8px 10px;
        margin-bottom: 6px;
        cursor: pointer;
        transition: border 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      }

      .search-result:hover {
        border-color: #bcd4f5;
        box-shadow: 0 6px 18px rgba(52, 152, 219, 0.14);
        transform: translateY(-1px);
      }

      .search-result-title {
        font-size: 11pt;
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .search-preview {
        font-size: 10pt;
        color: #526981;
        line-height: 1.45;
      }

      .search-result mark {
        background: #fff4c2;
        color: #2c3e50;
        padding: 0 2px;
        border-radius: 3px;
      }

      .search-hit-highlight {
        background: #fff8d6;
        transition: background 0.6s ease;
      }

      .search-shell.collapsed .search-toolbar {
        display: none;
      }

      .floating-toc {
        position: fixed;
        right: 22px;
        bottom: 28px;
        width: 320px;
        max-width: 85vw;
        z-index: 1200;
        font-size: 11pt;
        color: #1f2d3d;
      }

      .toc-toggle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 48px;
        height: 48px;
        border-radius: 24px;
        border: none;
        background: #ffffff;
        color: #2c3e50;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: transform 0.2s ease, box-shadow 0.25s ease, background 0.2s ease;
      }

      .toc-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 14px 36px rgba(0, 0, 0, 0.2);
        background: #f8fafc;
      }

      .toc-panel {
        pointer-events: none;
        opacity: 0;
        transform: translateY(12px);
        transition: opacity 0.25s ease, transform 0.25s ease;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(5px);
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 10px;
        max-height: min(70vh, 520px);
        overflow: hidden;
      }

      .floating-toc.open .toc-panel {
        pointer-events: auto;
        opacity: 1;
        transform: translateY(0);
      }

      .floating-toc.open .toc-toggle {
        transform: rotate(45deg);
        background: #eaf1ff;
      }

      .toc-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid #ecf0f1;
      }

      .toc-kicker {
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-size: 9pt;
        color: #7f8c8d;
      }

      .toc-title {
        font-weight: 600;
        color: #1a252f;
        font-size: 12pt;
      }

      .toc-close {
        border: none;
        background: #f4f6f8;
        color: #34495e;
        width: 30px;
        height: 30px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      .toc-close:hover {
        background: #e7ebf0;
        transform: translateY(-1px);
      }

      .toc-body {
        margin-top: 8px;
        max-height: calc(min(70vh, 520px) - 56px);
        overflow-y: auto;
        padding-right: 4px;
      }

      .toc-section {
        margin-bottom: 6px;
        border-radius: 8px;
        transition: background 0.2s ease;
      }

      .toc-section:hover {
        background: #f8fafc;
      }

      .toc-section-header {
        width: 100%;
        border: none;
        background: transparent;
        color: #1f2d3d;
        font-weight: 600;
        font-size: 11pt;
        text-align: left;
        padding: 8px 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        gap: 8px;
      }

      .toc-section-header .chevron {
        transition: transform 0.2s ease;
        font-size: 10pt;
        color: #7f8c8d;
      }

      .toc-section.open .chevron {
        transform: rotate(90deg);
      }

      .toc-section:hover .chevron {
        color: #3498db;
      }

      .toc-link {
        color: inherit;
        text-decoration: none;
        display: block;
        width: 100%;
      }

      .toc-sublist {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.25s ease;
        padding-left: 10px;
      }

      .toc-section.open .toc-sublist {
        max-height: 500px;
      }

      .toc-sub-link {
        display: block;
        color: #4a6075;
        text-decoration: none;
        font-size: 10pt;
        padding: 6px 8px;
        border-radius: 6px;
        transition: background 0.15s ease, color 0.15s ease;
      }

      .toc-sub-link:hover {
        background: #eaf1ff;
        color: #1f2d3d;
      }

      .toc-item-active > .toc-section-header,
      .toc-sub-link.active {
        background: #eaf1ff;
        color: #1a252f;
      }

      .toc-pill {
        position: absolute;
        top: -12px;
        right: 54px;
        padding: 6px 10px;
        background: #1f2d3d;
        color: white;
        border-radius: 999px;
        font-size: 9pt;
        letter-spacing: 0.04em;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        transform: translateY(6px);
        opacity: 0;
        transition: opacity 0.25s ease, transform 0.25s ease;
        pointer-events: none;
      }

      .floating-toc.open .toc-pill {
        opacity: 1;
        transform: translateY(0);
      }

      @media (max-width: 1024px) {
        .floating-toc {
          right: 12px;
          bottom: 18px;
        }

        .toc-panel {
          width: calc(100vw - 32px);
        }
      }

      @media (max-width: 720px) {
        .floating-toc {
          left: 50%;
          transform: translateX(-50%);
          width: calc(100vw - 30px);
        }

        .floating-toc.open .toc-panel {
          box-shadow: 0 16px 36px rgba(0, 0, 0, 0.15);
        }

        .toc-toggle {
          right: calc(50% - 24px);
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .floating-toc *,
        .floating-toc {
          transition: none !important;
        }
      }

      /* Geographic scope image sizing */
      .geo-scope {
        flex: 0 0 42%;
        max-width: 42%;
        min-width: 220px;
        margin-left: auto;
        margin-right: auto;
      }

      @media (max-width: 720px) {
        .geo-scope-wrap {
          flex-direction: column;
        }
        .geo-scope {
          flex: 1 1 100%;
          max-width: 100%;
        }
      }

      @media (max-width: 1400px) {
        .search-shell {
          right: 16px;
          width: calc(100vw - 60px);
        }
        .search-toolbar {
          box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
        }
      }

      @media (max-width: 720px) {
        .search-shell {
          top: 16px;
          width: calc(100vw - 32px);
        }
        .search-toggle {
          width: 100%;
          justify-content: center;
        }
        .search-input-row {
          grid-template-columns: 1fr;
        }
        .search-clear {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <button
      class="pdf-export-btn"
      onclick="enhancedPDFExport()"
      aria-label="Download PDF"
      title="Download PDF"
    >
      ‚¨áÔ∏é
    </button>

    <div class="search-shell collapsed" aria-label="Playbook search">
      <button type="button" class="search-toggle" id="search-toggle" aria-expanded="false" aria-controls="search-panel">
        üîç Search playbook
      </button>
      <div class="search-toolbar" id="search-panel" role="search" aria-label="Search the playbook">
        <label for="playbook-search">Search the playbook</label>
        <div class="search-input-row">
          <input
            type="search"
            id="playbook-search"
            class="search-field"
            placeholder="Search sections, tactics, or keywords"
            aria-label="Search the playbook"
          />
          <button type="button" id="clear-search" class="search-clear" aria-label="Clear search">Clear</button>
        </div>
        <div class="search-status" id="search-status">Search sections, tactics, or keywords.</div>
        <div class="search-results" id="search-results" role="listbox" aria-label="Search results"></div>
      </div>
    </div>

    <div class="floating-toc" aria-label="Table of contents">
      <div class="toc-pill">Navigate</div>
      <button class="toc-toggle" aria-expanded="false" aria-controls="toc-panel" title="Open table of contents">‚â°</button>
      <div class="toc-panel" id="toc-panel" role="navigation" aria-label="Table of contents">
        <div class="toc-panel-header">
          <div>
            <div class="toc-kicker">On this playbook</div>
            <div class="toc-title">Quick jump</div>
          </div>
          <button class="toc-close" aria-label="Close navigation">√ó</button>
        </div>
        <div class="toc-body">
          <div class="toc-list"></div>
        </div>
      </div>
    </div>

        <div class="container" id="document-content">
      <!-- DYNAMIC_CONTENT -->
      <div id="loading-message" style="text-align: center; padding: 40px; color: #666;">
        <p>Loading playbook content...</p>
      </div>
    </div>

<script>
      const tocState = {
        observer: null,
        mutationObserver: null,
        rebuildTimer: null,
      };
      const SCROLL_STORAGE_KEY = "playbook-scroll-position";
      const ACTIVE_SECTION_KEY = "playbook-active-section";
      let scrollSaveTimer = null;
      let lastActiveSection = null;

      const smoothScrollToId = (targetId) => {
        const target = document.getElementById(targetId);
        if (!target) return;
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      };

      const setActiveTocItem = (activeId) => {
        document.querySelectorAll(".toc-sub-link.active, .toc-item-active").forEach((el) => {
          el.classList.remove("active", "toc-item-active");
        });

        const subLink = document.querySelector(`.toc-sub-link[data-target="${activeId}"]`);
        const sectionHeader = document.querySelector(`.toc-section-header[data-target="${activeId}"]`);

        if (subLink) {
          subLink.classList.add("active");
          const parent = subLink.closest(".toc-section");
          if (parent) {
            parent.classList.add("toc-item-active", "open");
          }
        } else if (sectionHeader) {
          const section = sectionHeader.closest(".toc-section");
          if (section) {
            section.classList.add("toc-item-active", "open");
          }
        }

        if (activeId) {
          lastActiveSection = activeId;
          try {
            localStorage.setItem(ACTIVE_SECTION_KEY, activeId);
          } catch (err) {
            console.warn("Unable to persist active section", err);
          }
        }
      };

      const buildFloatingToc = () => {
        const tocContainer = document.querySelector(".floating-toc");
        const tocList = tocContainer?.querySelector(".toc-list");
        if (!tocContainer || !tocList) return;

        tocList.innerHTML = "";
        if (tocState.observer) tocState.observer.disconnect();

        const headings = Array.from(document.querySelectorAll(".page h2, .page h3"));
        const usedIds = new Set();

        headings.forEach((heading, index) => {
          if (!heading.id) {
            const base =
              heading.textContent
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, "-")
                .replace(/^-+|-+$/g, "") || `section-${index + 1}`;

            let candidate = base;
            let counter = 1;
            while (usedIds.has(candidate)) {
              candidate = `${base}-${counter++}`;
            }
            heading.id = candidate;
            usedIds.add(candidate);
          } else {
            usedIds.add(heading.id);
          }
        });

        const sections = [];
        headings.forEach((heading) => {
          if (heading.tagName === "H2") {
            sections.push({ id: heading.id, title: heading.textContent.trim(), children: [] });
          } else if (sections.length) {
            sections[sections.length - 1].children.push({ id: heading.id, title: heading.textContent.trim() });
          }
        });

        const fragment = document.createDocumentFragment();
        sections.forEach((section, index) => {
          const sectionEl = document.createElement("div");
          sectionEl.className = "toc-section";
          if (index === 0) sectionEl.classList.add("open");

          const header = document.createElement("button");
          header.className = "toc-section-header toc-link";
          header.setAttribute("data-target", section.id);
          header.setAttribute("aria-expanded", sectionEl.classList.contains("open"));
          header.innerHTML = `<span>${section.title}</span><span class="chevron">‚Ä∫</span>`;
          header.addEventListener("click", () => {
            const isOpen = sectionEl.classList.toggle("open");
            header.setAttribute("aria-expanded", isOpen);
            smoothScrollToId(section.id);
          });

          const sublist = document.createElement("div");
          sublist.className = "toc-sublist";

          section.children.forEach((child) => {
            const link = document.createElement("a");
            link.className = "toc-sub-link";
            link.href = `#${child.id}`;
            link.setAttribute("data-target", child.id);
            link.textContent = child.title;
            sublist.appendChild(link);
          });

          sectionEl.appendChild(header);
          if (section.children.length) sectionEl.appendChild(sublist);
          fragment.appendChild(sectionEl);
        });

        tocList.appendChild(fragment);

        tocState.observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                setActiveTocItem(entry.target.id);
              }
            });
          },
          {
            rootMargin: "-35% 0px -45% 0px",
            threshold: [0.2, 0.5, 0.8],
          }
        );

        headings.forEach((heading) => tocState.observer.observe(heading));

        if (tocState.mutationObserver) tocState.mutationObserver.disconnect();
        tocState.mutationObserver = new MutationObserver(() => {
          clearTimeout(tocState.rebuildTimer);
          tocState.rebuildTimer = setTimeout(() => buildFloatingToc(), 250);
        });

        tocState.mutationObserver.observe(document.getElementById("document-content"), {
          childList: true,
          subtree: true,
        });
      };

      const setupTocToggle = () => {
        const tocContainer = document.querySelector(".floating-toc");
        const toggleBtn = tocContainer?.querySelector(".toc-toggle");
        const closeBtn = tocContainer?.querySelector(".toc-close");
        if (!tocContainer || !toggleBtn) return;

        const setOpen = (open) => {
          tocContainer.classList.toggle("open", open);
          toggleBtn.setAttribute("aria-expanded", String(open));
        };

        toggleBtn.addEventListener("click", () => {
          setOpen(!tocContainer.classList.contains("open"));
        });

        closeBtn?.addEventListener("click", () => setOpen(false));

        document.addEventListener("click", (event) => {
          if (!tocContainer.contains(event.target) && tocContainer.classList.contains("open")) {
            setOpen(false);
          }
        });
      };

      const registerSmoothScroll = () => {
        document.addEventListener("click", (event) => {
          const anchor = event.target.closest('a[href^="#"]');
          if (!anchor) return;

          const href = anchor.getAttribute("href");
          if (!href || href === "#") return;
          const targetId = href.replace("#", "");
          const target = document.getElementById(targetId) || document.querySelector(href);
          if (!target) return;

          event.preventDefault();
          smoothScrollToId(targetId);
        });
      };

      const saveScrollPosition = () => {
        try {
          localStorage.setItem(SCROLL_STORAGE_KEY, String(window.scrollY));
          if (lastActiveSection) {
            localStorage.setItem(ACTIVE_SECTION_KEY, lastActiveSection);
          }
        } catch (err) {
          console.warn("Unable to persist scroll position", err);
        }
      };

      const restoreScrollPosition = () => {
        let targetY = null;
        let targetId = null;

        try {
          const storedY = localStorage.getItem(SCROLL_STORAGE_KEY);
          targetId = localStorage.getItem(ACTIVE_SECTION_KEY);
          if (storedY !== null) {
            const parsed = parseFloat(storedY);
            if (Number.isFinite(parsed)) {
              targetY = parsed;
            }
          }
        } catch (err) {
          console.warn("Unable to read saved position", err);
        }

        const scrollNow = () => {
          if (targetId) {
            const el = document.getElementById(targetId);
            if (el) {
              el.scrollIntoView({ behavior: "auto", block: "start" });
              return;
            }
          }
          if (targetY !== null) {
            window.scrollTo({ top: targetY, behavior: "auto" });
          }
        };

        setTimeout(scrollNow, 120);
        setTimeout(scrollNow, 450);
      };

      const initializeNavigation = () => {
        setupTocToggle();
        buildFloatingToc();
        registerSmoothScroll();
      };

      const initializeSearch = () => {
        const searchInput = document.getElementById("playbook-search");
        const searchResults = document.getElementById("search-results");
        const searchStatus = document.getElementById("search-status");
        const clearSearchBtn = document.getElementById("clear-search");
        const searchShell = document.querySelector(".search-shell");
        const searchToggle = document.getElementById("search-toggle");

        if (!searchInput || !searchResults || !searchStatus || !searchShell) return;

        const setSearchOpen = (open) => {
          searchShell.classList.toggle("collapsed", !open);
          if (searchToggle) searchToggle.setAttribute("aria-expanded", String(open));
          if (open) {
            searchInput.focus();
            searchInput.select();
          } else {
            searchInput.blur();
            if (!searchInput.value) {
              searchResults.innerHTML = "";
              searchResults.classList.remove("active");
              searchStatus.textContent = "Search sections, tactics, or keywords.";
            }
          }
        };

        const searchableNodes = Array.from(document.querySelectorAll(".page h2, .page h3, .page h4, .page p, .page li"));
        const searchIndex = [];
        const searchIndexMap = new Map();

        searchableNodes.forEach((node, idx) => {
          const text = (node.textContent || "").trim().replace(/\s+/g, " ");
          if (!text) return;

          const page = node.closest(".page");
          const heading = page?.querySelector("h1, h2");
          const sectionTitle = heading ? heading.textContent.trim().replace(/\s+/g, " ") : "Playbook";
          const searchId = `search-target-${idx}`;

          node.dataset.searchId = searchId;

          const entry = {
            id: searchId,
            text,
            lower: text.toLowerCase(),
            node,
            sectionTitle,
          };

          searchIndex.push(entry);
          searchIndexMap.set(searchId, entry);
        });

        const escapeHTML = (str) =>
          str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");

        const highlightTerms = (text, terms) => {
          if (!terms.length) return escapeHTML(text);
          const pattern = terms.map((term) => term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")).join("|");
          const regex = new RegExp(`(${pattern})`, "gi");
          return text
            .split(regex)
            .map((segment, index) => {
              if (index % 2 === 1) {
                return `<mark>${escapeHTML(segment)}</mark>`;
              }
              return escapeHTML(segment);
            })
            .join("");
        };

        const renderResults = (value) => {
          const query = value.trim().toLowerCase();
          if (!query) {
            searchResults.innerHTML = "";
            searchResults.classList.remove("active");
            searchStatus.textContent = "Search sections, tactics, or keywords.";
            return;
          }

          const terms = query.split(/\s+/).filter(Boolean);
          const matches = searchIndex
            .map((item) => {
              const matchedTerms = terms.filter((term) => item.lower.includes(term));
              if (!matchedTerms.length) return null;
              const score = matchedTerms.length * 2 - Math.min(item.text.length, 260) / 260;
              return { ...item, matchedTerms, score };
            })
            .filter(Boolean)
            .sort((a, b) => b.score - a.score)
            .slice(0, 15);

          if (!matches.length) {
            searchResults.innerHTML = `<div class="search-result">No matches found.</div>`;
            searchResults.classList.add("active");
            searchStatus.textContent = `No matches for "${value.trim()}"`;
            return;
          }

          searchResults.innerHTML = matches
            .map((match) => {
              const preview = match.text.length > 220 ? `${match.text.slice(0, 220)}‚Ä¶` : match.text;
              const highlighted = highlightTerms(preview, terms);
              return `
                <button class="search-result" data-target="${match.id}" role="option" aria-label="Go to ${escapeHTML(match.sectionTitle)}">
                  <div class="search-result-title">${escapeHTML(match.sectionTitle)}</div>
                  <div class="search-preview">${highlighted}</div>
                </button>
              `;
            })
            .join("");
          searchResults.classList.add("active");
          searchStatus.textContent = `Showing ${matches.length} result${matches.length === 1 ? "" : "s"} for "${value.trim()}"`;
        };

        const focusMatch = (targetId) => {
          const entry = searchIndexMap.get(targetId);
          if (!entry) return;
          entry.node.scrollIntoView({ behavior: "smooth", block: "start" });
          entry.node.classList.add("search-hit-highlight");
          setTimeout(() => entry.node.classList.remove("search-hit-highlight"), 1800);
        };

        searchToggle?.addEventListener("click", () => {
          const isOpen = !searchShell.classList.contains("collapsed");
          setSearchOpen(!isOpen);
        });

        searchResults.addEventListener("click", (event) => {
          const target = event.target.closest(".search-result");
          if (!target) return;
          const targetId = target.getAttribute("data-target");
          if (targetId) {
            focusMatch(targetId);
            setSearchOpen(false);
          }
        });

        searchInput.addEventListener("focus", () => setSearchOpen(true));

        searchInput.addEventListener("input", (event) => {
          setSearchOpen(true);
          renderResults(event.target.value);
        });

        searchInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            const firstResult = searchResults.querySelector(".search-result");
            firstResult?.click();
          } else if (event.key === "Escape") {
            if (searchInput.value) {
              searchInput.value = "";
              renderResults("");
            } else {
              setSearchOpen(false);
            }
          }
        });

        clearSearchBtn?.addEventListener("click", () => {
          searchInput.value = "";
          renderResults("");
          searchInput.focus();
          setSearchOpen(true);
        });

        document.addEventListener("click", (event) => {
          if (!searchShell.contains(event.target) && !searchShell.classList.contains("collapsed") && !searchInput.value) {
            setSearchOpen(false);
          }
        });
      };

      // Split long sections into multiple exactly 11in tall pages
      function splitContentIntoPages() {
        console.log('üîÑ Starting page splitting...');
        
        const pages = Array.from(document.querySelectorAll(".page:not(#cover):not(#toc)"));
        console.log(`Found ${pages.length} content pages to process`);
        
        if (pages.length === 0) {
          console.log('‚ö†Ô∏è No pages found to split');
          return;
        }
        
        // Safety check: ensure we have content before attempting to split
        const hasContent = pages.some(p => {
          const content = p.querySelector(".page-content");
          return content && content.children.length > 0;
        });
        
        if (!hasContent) {
          console.log('‚ö†Ô∏è No content found in pages, skipping split to prevent data loss');
          return;
        }
        
        // Hide pages during splitting to prevent flash (polish)
        pages.forEach(page => {
          page.style.opacity = '0';
          page.style.transition = 'opacity 0.3s ease-in';
        });
        
        const PAGE_HEIGHT_IN = 11;
        const PAGE_HEIGHT_PX = PAGE_HEIGHT_IN * 96; // 96px per inch at screen resolution
        const PADDING_IN = 1; // 1 inch top padding
        const PADDING_PX = PADDING_IN * 96;
        const PAGE_NUMBER_SPACE_PX = 40; // Space for page number (0.42in) - reduced to allow more content
        const LINE_HEIGHT_BUFFER_PX = 10; // Smaller buffer so short lists can stay on the current page - reduced to allow more content
        const MAX_CONTENT_HEIGHT_PX = PAGE_HEIGHT_PX - PADDING_PX - PAGE_NUMBER_SPACE_PX - LINE_HEIGHT_BUFFER_PX; // Available content height with buffer
        const isHeadingLike = (el) => {
          if (!el || !el.tagName) return false;
          const tag = el.tagName.toUpperCase();
          if (tag === 'H2' || tag === 'H3' || tag === 'H4') return true;
          if (tag === 'P') {
            const text = (el.textContent || '').trim();
            // Treat short all-caps paragraphs as headings
            return text && text.length <= 140 && text === text.toUpperCase();
          }
          return false;
        };
        
        console.log(`Max content height: ${MAX_CONTENT_HEIGHT_PX}px (${MAX_CONTENT_HEIGHT_PX / 96}in)`);
        
        pages.forEach((originalPage, pageIdx) => {
          const content = originalPage.querySelector(".page-content");
          if (!content) {
            console.log(`‚ö†Ô∏è Page ${pageIdx} has no .page-content`);
            return;
          }
          
          // Save original styles
          const originalContentStyle = {
            maxHeight: content.style.maxHeight,
            overflow: content.style.overflow,
            height: content.style.height
          };
          
          const originalPageStyle = {
            height: originalPage.style.height,
            maxHeight: originalPage.style.maxHeight
          };
          
          // Temporarily remove restrictions for accurate measurement
          content.style.maxHeight = 'none';
          content.style.overflow = 'visible';
          content.style.height = 'auto';
          originalPage.style.height = 'auto';
          originalPage.style.maxHeight = 'none';
          
          // Force reflow for accurate measurements
          void originalPage.offsetHeight;
          void content.offsetHeight;
          
          // Measure actual content height
          const contentHeight = content.scrollHeight;
          console.log(`Page ${originalPage.id}: content height = ${contentHeight}px (${(contentHeight / 96).toFixed(2)}in), max = ${MAX_CONTENT_HEIGHT_PX}px`);
          
          // If content fits in one page, restore styles and move on
          if (contentHeight <= MAX_CONTENT_HEIGHT_PX + LINE_HEIGHT_BUFFER_PX) {
            console.log(`‚úÖ Page ${originalPage.id} fits in one page`);
            originalPage.style.height = '11in';
            originalPage.style.maxHeight = '11in';
            content.style.maxHeight = (MAX_CONTENT_HEIGHT_PX + LINE_HEIGHT_BUFFER_PX) + 'px';
            content.style.overflow = 'hidden';
            // Ensure original styles are restored properly
            originalPage.style.height = '11in';
            originalPage.style.maxHeight = '11in';
            return;
          }
          
          // Content exceeds - split it into multiple pages
          console.log(`‚úÇÔ∏è Splitting page ${originalPage.id} (content is ${contentHeight}px, exceeds ${MAX_CONTENT_HEIGHT_PX}px)`);
          
          const children = Array.from(content.children);
          if (children.length === 0) {
            console.log(`‚ö†Ô∏è Page ${originalPage.id} has no children`);
            return;
          }
          
          // Store children data before manipulation
          const childrenData = children.map(child => ({
            element: child,
            html: child.outerHTML
          }));
          
          console.log(`  Stored ${childrenData.length} children for processing`);
          
          // Clear original content (will rebuild it)
          content.innerHTML = '';
          
          // Get section info
          const sectionId = originalPage.id.replace(/-page\d+$/, '');
          const pageNumberEl = originalPage.querySelector('.page-number');
          let basePageNum = pageNumberEl ? parseInt(pageNumberEl.textContent) : 3;
          
          const newPages = [];
          let currentPage = originalPage;
          let currentPageContent = content;
          let currentHeight = 0;
          let pageCounter = 1;
          
          // Process each child element
          childrenData.forEach((childData, childIdx) => {
            // Create a temporary container to measure the child
            const tempContainer = document.createElement('div');
            tempContainer.style.cssText = 'position: absolute; visibility: hidden; width: 7.5in;';
            tempContainer.innerHTML = childData.html;
            document.body.appendChild(tempContainer);
            
            // Get the actual element from temp container
            const childElement = tempContainer.firstElementChild;
            if (!childElement) {
              console.log(`  ‚ö†Ô∏è Child ${childIdx} has no element, skipping`);
              document.body.removeChild(tempContainer);
              return;
            }
            
            // Clone the element to avoid DOM manipulation issues
            const clonedElement = childElement.cloneNode(true);
            
            // Force reflow to measure height
            void childElement.offsetHeight;
            
            const childHeight = childElement.offsetHeight || 100;
            
            console.log(`  Child ${childIdx} (${clonedElement.tagName}): height = ${childHeight}px, current total = ${currentHeight}px`);
            
            // Track what was before this element so we can keep headings with their first block
            const prevBeforeAppend = currentPageContent.lastElementChild;

            // Try adding the cloned element to current page
            currentPageContent.appendChild(clonedElement);
            
            // Force reflow to get actual rendered height
            void currentPageContent.offsetHeight;
            void currentPage.offsetHeight;
            const actualHeight = currentPageContent.scrollHeight;
            
            // Check if the actual rendered height exceeds the page limit (with buffer)
            if (actualHeight > MAX_CONTENT_HEIGHT_PX + LINE_HEIGHT_BUFFER_PX) {
              console.log(`  ‚ö†Ô∏è Child ${childIdx} would cause overflow (actual: ${actualHeight}px > max: ${MAX_CONTENT_HEIGHT_PX + LINE_HEIGHT_BUFFER_PX}px), creating new page`);
              
              // If the previous element was a heading-like block, move it with this element
              let headingToMove = null;
              if (isHeadingLike(prevBeforeAppend) && currentPageContent.contains(prevBeforeAppend)) {
                headingToMove = prevBeforeAppend;
                currentPageContent.removeChild(prevBeforeAppend);
              }

              // Remove the cloned element from current page
              clonedElement.remove();
              
              // Create new page
              const newPage = document.createElement('div');
              newPage.className = 'page';
              newPage.id = `${sectionId}-page${pageCounter + 1}`;
              newPage.style.cssText = 'width: 8.5in; height: 11in; min-height: 11in; max-height: 11in; padding: 1in; margin: 0 auto 20px; background: white; position: relative; box-shadow: 0 2px 15px rgba(0, 0, 0, 0.15); overflow: hidden; page-break-after: always; break-after: page; box-sizing: border-box; display: flex; flex-direction: column;';
              
              const newContent = document.createElement('div');
              newContent.className = 'page-content';
              newContent.style.cssText = 'flex: 1; min-height: 0; overflow: hidden; padding-bottom: 0.5in;';
              
              newPage.appendChild(newContent);
              
              // Add page number
              const newPageNumber = document.createElement('div');
              newPageNumber.className = 'page-number';
              newPageNumber.textContent = basePageNum + pageCounter;
              newPageNumber.style.cssText = 'position: absolute; bottom: 0.5in; right: 1in; font-size: 10pt; color: #666;';
              newPage.appendChild(newPageNumber);
              
              // Insert after current page
              currentPage.parentElement.insertBefore(newPage, currentPage.nextSibling);
              newPages.push(newPage);
              
              // Switch to new page and add the cloned element
              currentPage = newPage;
              currentPageContent = newContent;
              
              // If we moved a heading, place it before the list
              if (headingToMove) {
                currentPageContent.appendChild(headingToMove);
              }
              currentPageContent.appendChild(clonedElement);
              
              // Update current height based on actual content
              void currentPageContent.offsetHeight;
              currentHeight = currentPageContent.scrollHeight;
              pageCounter++;
            } else {
              // Element fits, update current height
              currentHeight = actualHeight;
            }
            
            // Clean up temp container
            document.body.removeChild(tempContainer);
          });
          
          // Ensure all pages have correct height and overflow settings
          // Also verify no content is cut off at the bottom
          [originalPage, ...newPages].forEach((p, idx) => {
            p.style.height = '11in';
            p.style.maxHeight = '11in';
            const pc = p.querySelector('.page-content');
            if (pc) {
              // Set max height with buffer to prevent cutoff
              pc.style.maxHeight = (MAX_CONTENT_HEIGHT_PX + LINE_HEIGHT_BUFFER_PX) + 'px';
              pc.style.overflow = 'hidden';
              
                  // Final check: if content still exceeds, remove last element and move to next page
              void pc.offsetHeight;
              const finalScrollHeight = pc.scrollHeight;
              if (finalScrollHeight > MAX_CONTENT_HEIGHT_PX + LINE_HEIGHT_BUFFER_PX) {
                console.log(`  ‚ö†Ô∏è Page ${p.id} still exceeds limit (${finalScrollHeight}px), moving last element to next page`);
                const lastChild = pc.lastElementChild;
                if (lastChild) {
                  // Try to move to next page if it exists
                  if (idx < newPages.length && newPages[idx]) {
                    const nextPageContent = newPages[idx].querySelector('.page-content');
                    if (nextPageContent) {
                      lastChild.remove();
                      nextPageContent.insertBefore(lastChild, nextPageContent.firstChild);
                      console.log(`  ‚úÖ Moved last element to next page`);
                    }
                  } else {
                    // No next page exists, create one
                    console.log(`  ‚ö†Ô∏è No next page exists, keeping content but may overflow`);
                  }
                }
              }
            }
          });
          
          // Final safety check: ensure no pages are empty
          const allPages = [originalPage, ...newPages];
          let hasEmptyPages = false;
          allPages.forEach((p, idx) => {
            const pc = p.querySelector('.page-content');
            if (pc && pc.children.length === 0) {
              console.log(`  ‚ö†Ô∏è WARNING: Page ${p.id} is empty after splitting!`);
              hasEmptyPages = true;
            } else {
              console.log(`  ‚úÖ Page ${p.id} has ${pc?.children.length || 0} children`);
            }
          });
          
          // If we have empty pages, something went wrong - restore original content
          if (hasEmptyPages && childrenData.length > 0) {
            console.log(`  ‚ö†Ô∏è Empty pages detected, attempting to restore content...`);
            content.innerHTML = '';
            childrenData.forEach(childData => {
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = childData.html;
              while (tempDiv.firstChild) {
                content.appendChild(tempDiv.firstChild);
              }
            });
            // Remove any new pages we created
            newPages.forEach(np => np.remove());
            console.log(`  ‚úÖ Content restored to original page`);
          } else {
            console.log(`‚úÖ Split page ${originalPage.id} into ${newPages.length + 1} pages`);
          }
          
          // Show page after splitting is complete (polish)
          allPages.forEach(p => {
            p.style.opacity = '1';
          });
        });
        
        // Show all pages after splitting is complete (polish)
        const allProcessedPages = Array.from(document.querySelectorAll(".page:not(#cover):not(#toc)"));
        allProcessedPages.forEach(page => {
          page.style.opacity = '1';
        });
        
        console.log('‚úÖ Page splitting complete');
      }

      // Load dynamic playbook content
      async function loadPlaybookContent() {
        const container = document.getElementById("document-content");
        const loadingHtml = '<div id="loading-message" style="text-align: center; padding: 40px; color: #666;"><p>Loading playbook content...</p></div>';
        // Always reset container to a clean loading state
        container.innerHTML = `<!-- DYNAMIC_CONTENT -->${loadingHtml}`;

        try {
          const response = await fetch("/api/playbook");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          
          // Replace loading message with content
          const loadingMsg = document.getElementById("loading-message");
          if (loadingMsg) {
            loadingMsg.outerHTML = data.html;
          } else {
            // If no loading message, insert content
            container.innerHTML = '<!-- DYNAMIC_CONTENT -->' + data.html;
          }
          
          console.log(`‚úÖ Playbook loaded: ${data.sections} sections`);
          
          // Initialize navigation and search after content loads
          // Use multiple timeouts to ensure content is fully rendered before splitting
          setTimeout(() => {
            splitContentIntoPages();
            // Re-run after longer delay to catch any late-rendered content
            setTimeout(() => {
              splitContentIntoPages();
              initializeNavigation();
              initializeSearch();
              restoreScrollPosition();
            }, 500);
          }, 300);
        } catch (error) {
          console.error("‚ùå Error loading playbook:", error);
          const loadingMsg = document.getElementById("loading-message");
          if (loadingMsg) {
            loadingMsg.innerHTML = `
              <p><strong>Error loading playbook content</strong></p>
              <p>${error.message}</p>
              <p><button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; cursor: pointer;">Retry</button></p>
            `;
            loadingMsg.style.color = "#e74c3c";
          }
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadPlaybookContent();

        const onScroll = () => {
          if (scrollSaveTimer) clearTimeout(scrollSaveTimer);
          scrollSaveTimer = setTimeout(saveScrollPosition, 150);
        };

        window.addEventListener("scroll", onScroll, { passive: true });
        window.addEventListener("beforeunload", saveScrollPosition);
      });

      // PDF Export Function
      function exportToPDF() {
        const btn = document.querySelector(".pdf-export-btn");
        const originalText = btn.textContent;

        btn.classList.add("exporting");
        btn.textContent = "‚è≥ Generating PDF...";
        btn.disabled = true;

        // Wait for images to load
        const images = document.querySelectorAll("img");
        const imagePromises = Array.from(images).map((img) => {
          if (img.complete && img.naturalWidth > 0) {
            return Promise.resolve();
          }
          return new Promise((resolve) => {
            img.onload = resolve;
            img.onerror = resolve; // Continue even if image fails
            setTimeout(resolve, 3000); // Timeout after 3 seconds
          });
        });

        Promise.all(imagePromises).then(() => {
          // Small delay to ensure everything is rendered
          setTimeout(() => {
            const element = document.getElementById("document-content");

            if (!element) {
              console.error("Document content element not found");
              btn.classList.remove("exporting");
              btn.textContent = "‚ùå Error - Element not found";
              btn.disabled = false;
              return;
            }

            // Ensure element is visible and has content
            if (element.offsetHeight === 0 || element.offsetWidth === 0) {
              console.error("Document content has no dimensions");
              btn.classList.remove("exporting");
              btn.textContent = "‚ùå Error - No content to export";
              btn.disabled = false;
              return;
            }

            // Scroll to top to ensure we start from the beginning
            window.scrollTo(0, 0);
            element.scrollIntoView({ behavior: "instant", block: "start" });

            // Hide UI elements that shouldn't be in PDF
            const exportBtn = document.querySelector(".pdf-export-btn");
            const floatingToc = document.querySelector(".floating-toc");
            const searchToolbar = document.querySelector(".search-toolbar");
            const searchShell = document.querySelector(".search-shell");
            const originalBtnDisplay = exportBtn ? exportBtn.style.display : "";
            const originalTocDisplay = floatingToc ? floatingToc.style.display : "";
            const originalSearchDisplay = searchToolbar ? searchToolbar.style.display : "";
            const originalSearchShell = searchShell ? searchShell.style.display : "";

            if (exportBtn) exportBtn.style.display = "none";
            if (floatingToc) floatingToc.style.display = "none";
            if (searchToolbar) searchToolbar.style.display = "none";
            if (searchShell) searchShell.style.display = "none";

            // Ensure element is visible and has proper dimensions
            const originalBodyBg = document.body.style.background;
            document.body.style.background = "#ffffff";

            // Force a reflow to ensure rendering
            void element.offsetHeight;

            // Temporarily adjust styles for better PDF rendering
            const pages = element.querySelectorAll(".page");
            const originalStyles = [];
            pages.forEach((page, index) => {
              originalStyles[index] = {
                overflow: page.style.overflow,
                height: page.style.height,
                minHeight: page.style.minHeight,
                maxHeight: page.style.maxHeight
              };
              // Allow pages to flow naturally
              page.style.overflow = "visible";
              page.style.height = "auto";
              page.style.minHeight = "auto";
              page.style.maxHeight = "none";
            });

            const opt = {
              margin: [0.5, 0.5, 0.5, 0.5],
              filename: "Specialty_Farmer_Program_Execution_Playbook.pdf",
              image: { type: "jpeg", quality: 0.98 },
              html2canvas: {
                scale: 2,
                useCORS: true,
                allowTaint: false,
                letterRendering: true,
                logging: false,
                backgroundColor: "#ffffff",
                removeContainer: false,
              },
              jsPDF: {
                unit: "in",
                format: "letter",
                orientation: "portrait",
              },
              pagebreak: {
                mode: "css",
                before: ".page#cover, .page#toc, h2",
                after: ".page#cover, .page#toc",
                avoid: [".pipeline-diagram", ".image-container"],
              },
            };

            // Use a promise to handle the export
            const pdfPromise = html2pdf().set(opt).from(element);

            const restoreStyles = () => {
              // Restore page styles
              pages.forEach((page, index) => {
                if (originalStyles[index]) {
                  page.style.overflow = originalStyles[index].overflow || "";
                  page.style.height = originalStyles[index].height || "";
                  page.style.minHeight = originalStyles[index].minHeight || "";
                  page.style.maxHeight = originalStyles[index].maxHeight || "";
                }
              });
              // Restore UI elements and styles
              if (exportBtn) exportBtn.style.display = originalBtnDisplay;
              if (floatingToc) floatingToc.style.display = originalTocDisplay;
              if (searchToolbar) searchToolbar.style.display = originalSearchDisplay;
              if (searchShell) searchShell.style.display = originalSearchShell;
              document.body.style.background = originalBodyBg;
            };

            pdfPromise
              .save()
              .then(() => {
                restoreStyles();
                btn.classList.remove("exporting");
                btn.textContent = originalText;
                btn.disabled = false;
              })
              .catch((error) => {
                console.error("PDF export error:", error);
                console.error("Element dimensions:", {
                  width: element.offsetWidth,
                  height: element.offsetHeight,
                  scrollWidth: element.scrollWidth,
                  scrollHeight: element.scrollHeight,
                });

                restoreStyles();
                btn.classList.remove("exporting");
                btn.textContent = "‚ùå Error - Try Again";
                btn.disabled = false;
                setTimeout(() => {
                  btn.textContent = originalText;
                }, 3000);
              });
          }, 500);
        });
      }

      // Handle logo loading
      window.addEventListener("load", function () {
        const logo = document.getElementById("ssw-logo");
        if (logo) {
          logo.addEventListener("load", function () {
            this.style.display = "block";
          });
          logo.addEventListener("error", function () {
            // Logo not found, hide the container
            this.parentElement.style.display = "none";
          });
          // Try to load the logo
          const logoPath = "assets/logo/ssw-logo.png";
          const testImg = new Image();
          testImg.onload = function () {
            logo.src = logoPath;
            logo.style.display = "block";
          };
          testImg.onerror = function () {
            // Logo not found, hide container
            document.querySelector(".logo-container").style.display = "none";
          };
          testImg.src = logoPath;
        }
      });
    </script>
  </body>
</html>
